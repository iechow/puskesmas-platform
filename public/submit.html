<!DOCTYPE html>
<html>
<head>
  <title>Kirim Kegiatan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<h2>ðŸ“¤ Kirim Usulan Kegiatan</h2>

<input id="judul" placeholder="Judul"><br><br>
<input id="lokasi" placeholder="Lokasi"><br><br>
<input id="tanggal" type="date"><br><br>
<textarea id="deskripsi" placeholder="Deskripsi"></textarea><br><br>

<input type="file" id="foto" accept="image/*"><br><br>
<img id="preview" style="max-width:100%; display:none; border:1px solid #ccc;"><br><br>

<button onclick="kirim()">Kirim</button>

<pre id="hasil"></pre>

<script>
const fotoInput = document.getElementById("foto");
const preview = document.getElementById("preview");

fotoInput.onchange = () => {
  const file = fotoInput.files[0];
  if (!file) return;
  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";
};

async function kirim() {
  const file = fotoInput.files[0];
  if (!file) return alert("Pilih foto dulu");

  const fd = new FormData();
  fd.append("judul", judul.value);
  fd.append("lokasi", lokasi.value);
  fd.append("tanggal", tanggal.value);
  fd.append("deskripsi", deskripsi.value);
  fd.append("foto", file);

  const res = await fetch("/api/kegiatan", {
    method: "POST",
    body: fd
  });

  hasil.textContent = await res.text();
}
</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  "https://gtbxoqzndwjkdyweopu.supabase.co",
  "sb_publishable_QEKex4ZE2L1Z7xnkxPJi1A_oGA1ZJid"
);

async function kirim() {
  const judul = document.getElementById("judul").value;
  const lokasi = document.getElementById("lokasi").value;
  const tanggal = document.getElementById("tanggal").value;
  const deskripsi = document.getElementById("deskripsi").value;
  const file = document.getElementById("foto").files[0];

  if (!file) {
    alert("Pilih foto dulu");
    return;
  }

  // 1. Upload foto ke Supabase Storage
  const filename = Date.now() + "-" + file.name;
  const { data, error } = await supabase.storage
    .from("kegiatan")
    .upload(filename, file);

  if (error) {
    alert("Upload foto gagal: " + error.message);
    return;
  }

  // 2. Ambil URL publik
  const { data: urlData } = supabase.storage
    .from("kegiatan")
    .getPublicUrl(filename);

  const foto_url = urlData.publicUrl;

  // 3. Simpan data ke tabel kegiatan
  const res = await fetch("/api/kegiatan", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      judul,
      lokasi,
      tanggal,
      deskripsi,
      foto_url
    })
  });

  const data = await res.json();

if (data.status === "ok") {
  alert("Usulan terkirim! Menunggu verifikasi.");
  window.location.href = "/"; // kembali ke beranda
} else {
  alert("Gagal mengirim.");
}
</script>
</body>
</html>
